<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOD & Engineer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .dashboard-section {
            border-radius: 12px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .dashboard-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .bg-hod-requests { background-color: #fef3c7; } /* Yellow */
        .bg-hod-stock-list { background-color: #dbeafe; } /* Blue */
        .bg-hod-engineer-stock { background-color: #d1fae5; } /* Green */
        .bg-hod-usage-log { background-color: #ede9fe; } /* Purple */
        .bg-hod-engineer-management { background-color: #e2e8f0; } /* Gray */
        .bg-engineer-available-stock { background-color: #e2fbd5; } /* Pale Green */
        .bg-engineer-requests { background-color: #ffedd5; } /* Orange */
        .bg-engineer-personal-stock { background-color: #e0f2fe; } /* Light Blue */
        .bg-engineer-usage { background-color: #f3e8ff; } /* Light Purple */
        .login-container {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4 sm:p-6">

    <div id="login-screen" class="login-container">
        <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
        <div class="mb-4">
            <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
            <input type="text" id="username" name="username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        <div class="mb-6">
            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" id="password" name="password" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
        </div>
        <button onclick="login()" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Login
        </button>
        <div id="login-message" class="mt-4 text-center text-red-500 hidden"></div>
    </div>

    <div id="dashboard-container" class="w-full max-w-7xl hidden">
        <nav class="bg-gray-800 text-white p-4 rounded-lg shadow-lg mb-6">
            <ul id="navbar-list" class="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-6 sm:space-x-10">
                <!-- Navigation links will be dynamically added here -->
            </ul>
        </nav>

        <div id="hod-dashboard" class="hidden">
            <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8">HOD Dashboard</h1>
            <div id="hod-urgent-alerts" class="mb-6 hidden">
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Urgent Alert!</strong>
                    <span class="block sm:inline" id="hod-alert-message"></span>
                </div>
            </div>

            <!-- Stock Requests Section -->
            <section id="hod-requests-section" class="dashboard-section bg-hod-requests">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Stock Requests</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-yellow-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested By</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hod-requests-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>

            <!-- Stock Management Section -->
            <section id="hod-stock-section" class="dashboard-section bg-hod-stock-list">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Stock Management</h2>
                <form id="add-stock-form" class="mb-6 flex flex-wrap gap-4 items-end">
                    <div class="flex flex-col">
                        <label for="stock-name" class="text-sm font-medium text-gray-700">Stock Name</label>
                        <input type="text" id="stock-name" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="stock-quantity" class="text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="stock-quantity" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700">Add Stock</button>
                </form>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stock-list-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Engineer Management Section -->
            <section id="hod-engineer-management-section" class="dashboard-section bg-hod-engineer-management hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Engineers</h2>
                <form id="add-engineer-form" class="mb-6 flex flex-wrap gap-4 items-end">
                    <div class="flex flex-col">
                        <label for="engineer-username" class="text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="engineer-username" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="engineer-password" class="text-sm font-medium text-gray-700">Password</label>
                        <input type="text" id="engineer-password" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700">Add Engineer</button>
                </form>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Password</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="engineer-list-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>

            <!-- Engineer Personal Stock Section -->
            <section id="hod-engineer-stock-section" class="dashboard-section bg-hod-engineer-stock">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Engineer Personal Stock</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-green-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Engineer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="hod-engineer-stock-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>

            <!-- Stock Usage Log Section -->
            <section id="hod-usage-log-section" class="dashboard-section bg-hod-usage-log">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Stock Usage Log</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-purple-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Engineer</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AMC/CMC</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="hod-usage-log-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>
        </div>

        <div id="engineer-dashboard" class="hidden">
            <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8">Engineer Dashboard</h1>
            <div id="engineer-urgent-alerts" class="mb-6 hidden">
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">Urgent Alert!</strong>
                    <span class="block sm:inline" id="engineer-alert-message"></span>
                </div>
            </div>

            <!-- Available Main Stock Section -->
            <section id="engineer-available-stock-section" class="dashboard-section bg-engineer-available-stock">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Available Main Stock</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-green-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                            </tr>
                        </thead>
                        <tbody id="engineer-available-stock-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Stock Request Section -->
            <section id="engineer-requests-section" class="dashboard-section bg-engineer-requests">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Stock Requests</h2>
                <form id="request-stock-form" class="mb-6 flex flex-col sm:flex-row flex-wrap gap-4 items-end">
                    <div class="flex flex-col flex-grow">
                        <label for="request-stock-name" class="text-sm font-medium text-gray-700">Stock Name</label>
                        <select id="request-stock-name" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required></select>
                    </div>
                    <div class="flex flex-col">
                        <label for="request-quantity" class="text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="request-quantity" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="request-remarks" class="text-sm font-medium text-gray-700">Remarks</label>
                        <input type="text" id="request-remarks" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700">Send Request</button>
                </form>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-orange-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remarks</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Docket Number</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="engineer-requests-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Urgent Stock Request Section -->
            <section id="engineer-urgent-section" class="dashboard-section bg-red-50">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Urgent Stock Request</h2>
                <form id="urgent-request-form" class="mb-6 flex flex-col sm:flex-row flex-wrap gap-4 items-end">
                    <div class="flex flex-col flex-grow">
                        <label for="urgent-stock-name" class="text-sm font-medium text-gray-700">Stock Name</label>
                        <input type="text" id="urgent-stock-name" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="urgent-quantity" class="text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="urgent-quantity" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="urgent-remarks" class="text-sm font-medium text-gray-700">Remarks</label>
                        <input type="text" id="urgent-remarks" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                    </div>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white font-medium rounded-md hover:bg-red-700">Send Urgent Request</button>
                </form>
            </section>
            
            <!-- Engineer's Personal Stock Section -->
            <section id="engineer-personal-stock-section" class="dashboard-section bg-engineer-personal-stock">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">My Personal Stock</h2>
                <form id="add-personal-stock-form" class="mb-6 flex flex-col sm:flex-row flex-wrap gap-4 items-end">
                    <div class="flex flex-col">
                        <label for="personal-stock-name" class="text-sm font-medium text-gray-700">Stock Name</label>
                        <input type="text" id="personal-stock-name" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="personal-stock-quantity" class="text-sm font-medium text-gray-700">Quantity</label>
                        <input type="number" id="personal-stock-quantity" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700">Add/Update Stock</button>
                </form>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="engineer-personal-stock-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>
            
            <!-- Stock Usage Log Section -->
            <section id="engineer-usage-section" class="dashboard-section bg-engineer-usage">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Stock Usage</h2>
                <form id="use-stock-form" class="mb-6 flex flex-col sm:flex-row flex-wrap gap-4 items-end">
                    <div class="flex flex-col flex-grow">
                        <label for="use-stock-name" class="text-sm font-medium text-gray-700">Stock Name</label>
                        <select id="use-stock-name" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required></select>
                    </div>
                    <div class="flex flex-col">
                        <label for="use-quantity" class="text-sm font-medium text-gray-700">Quantity Used</label>
                        <input type="number" id="use-quantity" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="site-name" class="text-sm font-medium text-gray-700">Site Name</label>
                        <input type="text" id="site-name" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="use-reason" class="text-sm font-medium text-gray-700">Reason</label>
                        <input type="text" id="use-reason" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                    </div>
                    <div class="flex flex-col">
                        <label for="amc-cmc" class="text-sm font-medium text-gray-700">AMC/CMC</label>
                        <select id="amc-cmc" class="mt-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" required>
                            <option value="">Select</option>
                            <option value="AMC">AMC</option>
                            <option value="CMC">CMC</option>
                        </select>
                    </div>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-md hover:bg-indigo-700">Add to Log</button>
                </form>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-purple-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Site Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reason</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AMC/CMC</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="engineer-usage-table" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </section>
        </div>
    </div>

    <!-- Custom Modal/Alert for messages -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-content"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-close-btn" class="px-4 py-2 bg-indigo-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Data storage, acting as a simple database
        let stockList = [
            { id: 'stock-001', name: 'Laptop', quantity: 15, timestamp: new Date().toLocaleString() },
            { id: 'stock-002', name: 'Server', quantity: 5, timestamp: new Date().toLocaleString() },
            { id: 'stock-003', name: 'Router', quantity: 25, timestamp: new Date().toLocaleString() },
        ];
        let stockRequests = [];
        let engineerPersonalStock = {}; // Key: engineerId, Value: array of stocks
        let stockUsageLog = [];
        
        // HOD Credentials
        const hodCredentials = {
            username: 'PTESPL',
            password: 'ptespl@123'
        };

        // Engineer Credentials (now in an array)
        let engineerUsers = [
            { username: 'Eng-Alice', password: 'password', id: 'eng-1' }
        ];

        const alertThresholds = {
            yellow: 2 * 24 * 60 * 60 * 1000, // 2 days in ms
            red: 5 * 24 * 60 * 60 * 1000,   // 5 days in ms
            urgent: 7 * 24 * 60 * 60 * 1000 // 7 days in ms
        };

        const sendAlertThresholds = {
            yellow: 1 * 24 * 60 * 60 * 1000,  // 1 day
            orange: 2 * 24 * 60 * 60 * 1000,  // 2 days
            red: 5 * 24 * 60 * 60 * 1000,     // 5 days
            mail: 8 * 24 * 60 * 60 * 1000     // 8 days
        };

        let currentUser = null;
        let lastUrgentAlertTimestamp = 0; // To prevent spamming

        // DOM elements
        const loginScreen = document.getElementById('login-screen');
        const dashboardContainer = document.getElementById('dashboard-container');
        const hodDashboard = document.getElementById('hod-dashboard');
        const engineerDashboard = document.getElementById('engineer-dashboard');
        const navbarList = document.getElementById('navbar-list');
        const hodRequestsTable = document.getElementById('hod-requests-table');
        const stockListTable = document.getElementById('stock-list-table');
        const engineerRequestsTable = document.getElementById('engineer-requests-table');
        const engineerPersonalStockTable = document.getElementById('engineer-personal-stock-table');
        const hodEngineerStockTable = document.getElementById('hod-engineer-stock-table');
        const engineerUsageTable = document.getElementById('engineer-usage-table');
        const hodUsageLogTable = document.getElementById('hod-usage-log-table');
        const engineerAvailableStockTable = document.getElementById('engineer-available-stock-table');
        const hodUrgentAlerts = document.getElementById('hod-urgent-alerts');
        const hodAlertMessage = document.getElementById('hod-alert-message');
        const engineerUrgentAlerts = document.getElementById('engineer-urgent-alerts');
        const engineerAlertMessage = document.getElementById('engineer-alert-message');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // Event Listeners
        document.getElementById('add-stock-form').addEventListener('submit', addStock);
        document.getElementById('add-engineer-form').addEventListener('submit', addEngineer);
        document.getElementById('request-stock-form').addEventListener('submit', sendStockRequest);
        document.getElementById('urgent-request-form').addEventListener('submit', sendUrgentRequest);
        document.getElementById('add-personal-stock-form').addEventListener('submit', addPersonalStock);
        document.getElementById('use-stock-form').addEventListener('submit', useStock);
        modalCloseBtn.addEventListener('click', () => modal.classList.add('hidden'));

        // Function to show custom modal instead of alert
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalContent.textContent = message;
            modal.classList.remove('hidden');
        }
        
        // Function to handle logout
        function logout() {
            currentUser = null;
            loginScreen.classList.remove('hidden');
            dashboardContainer.classList.add('hidden');
            hodDashboard.classList.add('hidden');
            engineerDashboard.classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-message').classList.add('hidden');
            showModal('Logged Out', 'You have been successfully logged out.');
        }

        // --- Core Functions ---

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            let authenticated = false;

            if (username === hodCredentials.username && password === hodCredentials.password) {
                currentUser = { role: 'HOD', name: 'HOD' };
                authenticated = true;
            } else {
                const engineer = engineerUsers.find(eng => eng.username === username && eng.password === password);
                if (engineer) {
                    currentUser = { role: 'Engineer', name: engineer.username };
                    authenticated = true;
                }
            }

            if (authenticated) {
                loginScreen.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                if (currentUser.role === 'HOD') {
                    hodDashboard.classList.remove('hidden');
                    engineerDashboard.classList.add('hidden');
                } else {
                    engineerDashboard.classList.remove('hidden');
                    hodDashboard.classList.add('hidden');
                }
                updateNavbar();
                renderDashboards();
            } else {
                const loginMessage = document.getElementById('login-message');
                loginMessage.textContent = 'Invalid username or password.';
                loginMessage.classList.remove('hidden');
            }
        }

        function updateNavbar() {
            navbarList.innerHTML = '';
            if (currentUser.role === 'HOD') {
                navbarList.innerHTML = `
                    <li><a href="#hod-requests-section" class="py-2 px-4 rounded-md hover:bg-gray-700">Stock Requests</a></li>
                    <li><a href="#hod-stock-section" class="py-2 px-4 rounded-md hover:bg-gray-700">Stock Management</a></li>
                    <li><a href="#hod-engineer-management-section" class="py-2 px-4 rounded-md hover:bg-gray-700">Manage Engineers</a></li>
                    <li><a href="#hod-engineer-stock-section" class="py-2 px-4 rounded-md hover:bg-gray-700">Engineer Stock</a></li>
                    <li><a href="#hod-usage-log-section" class="py-2 px-4 rounded-md hover:bg-gray-700">Stock Usage Log</a></li>
                    <li><a href="#" onclick="logout()" class="py-2 px-4 rounded-md hover:bg-gray-700">Logout</a></li>
                `;
            } else if (currentUser.role === 'Engineer') {
                navbarList.innerHTML = `
                    <li><a href="#engineer-available-stock-section" class="py-2 px-4 rounded-md hover:bg-gray-700">Available Stock</a></li>
                    <li><a href="#engineer-requests-section" class="py-2 px-4 rounded-md hover:bg-gray-700">Stock Requests</a></li>
                    <li><a href="#engineer-urgent-section" class="py-2 px-4 rounded-md hover:bg-gray-700">Urgent Request</a></li>
                    <li><a href="#engineer-personal-stock-section" class="py-2 px-4 rounded-md hover:bg-gray-700">My Stock</a></li>
                    <li><a href="#engineer-usage-section" class="py-2 px-4 rounded-md hover:bg-gray-700">Stock Usage</a></li>
                    <li><a href="#" onclick="logout()" class="py-2 px-4 rounded-md hover:bg-gray-700">Logout</a></li>
                `;
            }
        }

        function renderDashboards() {
            renderHODRequests();
            renderStockList();
            renderEngineerManagement();
            renderHODEngineerStock();
            renderHODUsageLog();
            renderEngineerRequests();
            renderEngineerPersonalStock();
            renderEngineerUsageLog();
            renderEngineerAvailableStock();
            checkForAlerts();
            updateStockDropdowns();
        }

        // --- HOD Functions ---

        function renderHODRequests() {
            hodRequestsTable.innerHTML = '';
            const now = new Date();
            stockRequests.forEach(request => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                let statusColorClass = '';
                const timeElapsed = now - new Date(request.timestamp);
                
                if (request.status === 'Pending' && timeElapsed >= alertThresholds.urgent) {
                    statusColorClass = 'bg-red-500 text-white';
                } else if (request.status === 'Pending' && timeElapsed >= alertThresholds.red) {
                    statusColorClass = 'bg-red-500 text-white';
                } else if (request.status === 'Pending' && timeElapsed >= alertThresholds.yellow) {
                    statusColorClass = 'bg-yellow-400 text-gray-800';
                }

                if (request.status === 'Accepted') {
                    const sendTimeElapsed = now - new Date(request.acceptedTimestamp);
                    if (sendTimeElapsed >= sendAlertThresholds.mail) {
                         // Send email alert logic (simulated)
                         console.log(`Sending email to service.aur@ptespl.com for un-sent request: ${request.id}`);
                         // This is where you'd integrate an actual mail sending service
                    }
                    if (sendTimeElapsed >= sendAlertThresholds.red) {
                        statusColorClass = 'bg-red-500 text-white';
                    } else if (sendTimeElapsed >= sendAlertThresholds.orange) {
                        statusColorClass = 'bg-orange-400 text-gray-800';
                    } else if (sendTimeElapsed >= sendAlertThresholds.yellow) {
                        statusColorClass = 'bg-yellow-400 text-gray-800';
                    }
                }

                const actionsHtml = `
                    <div class="flex flex-col space-y-2">
                        <input type="text" id="docket-${request.id}" placeholder="Docket No." class="w-full px-2 py-1 border border-gray-300 rounded-md text-sm">
                        <button onclick="sendStock('${request.id}')" class="px-3 py-1 bg-indigo-600 text-white text-xs font-medium rounded-md hover:bg-indigo-700">Send</button>
                    </div>
                `;
                
                let actionButtons = '';
                if (request.status === 'Pending') {
                    actionButtons = `
                        <div class="flex flex-col space-y-2 sm:flex-row sm:space-x-2 sm:space-y-0">
                            <button onclick="acceptRequest('${request.id}')" class="px-3 py-1 bg-green-500 text-white text-xs font-medium rounded-md hover:bg-green-600">Accept</button>
                            <button onclick="rejectRequest('${request.id}')" class="px-3 py-1 bg-red-500 text-white text-xs font-medium rounded-md hover:bg-red-600">Reject</button>
                        </div>
                    `;
                } else if (request.status === 'Accepted') {
                    actionButtons = actionsHtml;
                } else if (request.status === 'In Transit') {
                    actionButtons = `<span class="text-sm text-gray-500">Waiting for delivery...</span>`;
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.stockName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.requestedBy}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${request.remarks}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">
                            ${request.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.timestamp}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${actionButtons}</td>
                `;
                hodRequestsTable.appendChild(row);
            });
        }

        function acceptRequest(id) {
            const request = stockRequests.find(req => req.id === id);
            if (!request) return;

            const stock = stockList.find(s => s.name === request.stockName);

            if (stock && stock.quantity >= request.quantity) {
                request.status = 'Accepted';
                request.timestamp = new Date().toLocaleString();
                request.acceptedTimestamp = new Date();
                renderDashboards();
                showModal('Request Accepted', `The request for ${request.stockName} has been accepted.`);
            } else {
                showModal('Insufficient Stock', `There is not enough ${request.stockName} in stock to fulfill this request.`);
            }
        }

        function rejectRequest(id) {
            const requestIndex = stockRequests.findIndex(req => req.id === id);
            if (requestIndex === -1) return;

            stockRequests.splice(requestIndex, 1);
            renderDashboards();
            showModal('Request Rejected', `The request has been rejected and removed.`);
        }

        function sendStock(id) {
            const request = stockRequests.find(req => req.id === id);
            if (!request) return;
            const docketInput = document.getElementById(`docket-${id}`);
            const docketNumber = docketInput ? docketInput.value : null;

            if (!docketNumber) {
                showModal('Invalid Docket Number', 'Please enter a valid docket number.');
                return;
            }

            const stock = stockList.find(s => s.name === request.stockName);
            if (stock && stock.quantity >= request.quantity) {
                stock.quantity -= request.quantity;
                stock.timestamp = new Date().toLocaleString();

                request.status = 'In Transit';
                request.docketNumber = docketNumber;
                request.timestamp = new Date().toLocaleString();

                renderDashboards();
                showModal('Stock Sent', `Stock for ${request.stockName} has been sent with docket number ${docketNumber}.`);
            } else {
                showModal('Insufficient Stock', `There is not enough ${request.stockName} in stock.`);
            }
        }

        function renderStockList() {
            stockListTable.innerHTML = '';
            stockList.forEach(stock => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${stock.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stock.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stock.timestamp}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editStock('${stock.id}')" class="px-3 py-1 bg-yellow-500 text-white text-xs font-medium rounded-md hover:bg-yellow-600 mr-2">Edit</button>
                        <button onclick="deleteStock('${stock.id}')" class="px-3 py-1 bg-red-500 text-white text-xs font-medium rounded-md hover:bg-red-600">Delete</button>
                    </td>
                `;
                stockListTable.appendChild(row);
            });
        }
        
        function addStock(event) {
            event.preventDefault();
            const name = document.getElementById('stock-name').value;
            const quantity = parseInt(document.getElementById('stock-quantity').value);

            if (name && quantity > 0) {
                const existingStock = stockList.find(s => s.name.toLowerCase() === name.toLowerCase());
                if (existingStock) {
                    existingStock.quantity += quantity;
                    existingStock.timestamp = new Date().toLocaleString();
                } else {
                    stockList.push({ id: `stock-${Date.now()}`, name, quantity, timestamp: new Date().toLocaleString() });
                }
                document.getElementById('add-stock-form').reset();
                renderDashboards();
                showModal('Stock Added', `Stock for ${name} has been added/updated.`);
            } else {
                showModal('Invalid Input', 'Please enter a valid name and quantity.');
            }
        }

        function editStock(id) {
            const stock = stockList.find(s => s.id === id);
            if (stock) {
                const newName = prompt(`Enter new name for "${stock.name}":`);
                if (newName !== null && newName.trim() !== '') {
                    stock.name = newName.trim();
                }

                const newQuantity = prompt(`Enter new quantity for "${stock.name}":`);
                if (newQuantity !== null && !isNaN(newQuantity) && newQuantity.trim() !== '') {
                    stock.quantity = parseInt(newQuantity);
                }

                if ((newName !== null && newName.trim() !== '') || (newQuantity !== null && !isNaN(newQuantity) && newQuantity.trim() !== '')) {
                    stock.timestamp = new Date().toLocaleString();
                    renderDashboards();
                    showModal('Stock Updated', `Stock for "${stock.name}" has been updated.`);
                } else {
                    showModal('Update Canceled', 'No changes were made.');
                }
            }
        }

        function deleteStock(id) {
            const stockIndex = stockList.findIndex(s => s.id === id);
            if (stockIndex > -1) {
                stockList.splice(stockIndex, 1);
                renderDashboards();
                showModal('Stock Deleted', `Stock item has been deleted.`);
            }
        }
        
        // New HOD function to manage engineers
        function renderEngineerManagement() {
            const section = document.getElementById('hod-engineer-management-section');
            const tableBody = document.getElementById('engineer-list-table');

            // Show section if HOD is logged in
            if (currentUser && currentUser.role === 'HOD') {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }

            tableBody.innerHTML = '';
            engineerUsers.forEach(engineer => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${engineer.username}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${engineer.password}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date().toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="deleteEngineer('${engineer.id}')" class="px-3 py-1 bg-red-500 text-white text-xs font-medium rounded-md hover:bg-red-600">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function addEngineer(event) {
            event.preventDefault();
            const username = document.getElementById('engineer-username').value;
            const password = document.getElementById('engineer-password').value;

            if (username && password) {
                const existingEngineer = engineerUsers.find(eng => eng.username === username);
                if (existingEngineer) {
                    showModal('Username Exists', 'An engineer with this username already exists.');
                    return;
                }

                engineerUsers.push({
                    username,
                    password,
                    id: `eng-${Date.now()}`
                });
                document.getElementById('add-engineer-form').reset();
                renderDashboards();
                showModal('Engineer Added', `New engineer "${username}" has been created.`);
            } else {
                showModal('Invalid Input', 'Please enter a valid username and password.');
            }
        }

        function deleteEngineer(id) {
            const engineerIndex = engineerUsers.findIndex(eng => eng.id === id);
            if (engineerIndex > -1) {
                engineerUsers.splice(engineerIndex, 1);
                renderDashboards();
                showModal('Engineer Deleted', 'Engineer account has been deleted.');
            }
        }

        function renderHODEngineerStock() {
            hodEngineerStockTable.innerHTML = '';
            for (const engineer in engineerPersonalStock) {
                engineerPersonalStock[engineer].forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${engineer}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.stockName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.timestamp}</td>
                    `;
                    hodEngineerStockTable.appendChild(row);
                });
            }
        }

        function renderHODUsageLog() {
            hodUsageLogTable.innerHTML = '';
            stockUsageLog.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.engineer}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.stockName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.siteName}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${log.reason}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.amcOrCmc}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.timestamp}</td>
                `;
                hodUsageLogTable.appendChild(row);
            });
        }

        // --- Engineer Functions ---

        function renderEngineerAvailableStock() {
            engineerAvailableStockTable.innerHTML = '';
            stockList.forEach(stock => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stock.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stock.quantity}</td>
                `;
                engineerAvailableStockTable.appendChild(row);
            });
        }
        
        function trackStock(requestId, docketNumber) {
            const request = stockRequests.find(req => req.id === requestId);
            if (!request) return;
            showModal('Tracking Details', `Your request for ${request.stockName} is in transit with Docket Number: ${docketNumber}. You can expect delivery soon.`);
        }

        function renderEngineerRequests() {
            engineerRequestsTable.innerHTML = '';
            const engineerRequests = stockRequests.filter(req => req.requestedBy === currentUser.name);

            engineerRequests.forEach(request => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                let statusColorClass = 'bg-gray-200 text-gray-800';
                let actionButtons = '';

                if (request.status === 'Accepted' && !request.docketNumber) {
                    statusColorClass = 'bg-green-100 text-green-800';
                    actionButtons = `
                        <button class="px-3 py-1 bg-yellow-500 text-white text-xs font-medium rounded-md hover:bg-yellow-600 mr-2" disabled>Awaiting Dispatch</button>
                    `;
                } else if (request.status === 'In Transit') {
                    statusColorClass = 'bg-blue-100 text-blue-800';
                    actionButtons = `
                        <button onclick="markAsReceived('${request.id}')" class="px-3 py-1 bg-green-500 text-white text-xs font-medium rounded-md hover:bg-green-600">Mark as Received</button>
                        <button onclick="trackStock('${request.id}', '${request.docketNumber}')" class="px-3 py-1 bg-blue-500 text-white text-xs font-medium rounded-md hover:bg-blue-600">Track</button>
                    `;
                } else if (request.status === 'Pending') {
                    statusColorClass = 'bg-gray-100 text-gray-800';
                    actionButtons = `
                        <div class="flex flex-col space-y-2 sm:flex-row sm:space-x-2 sm:space-y-0">
                            <button onclick="editRequest('${request.id}')" class="px-3 py-1 bg-yellow-500 text-white text-xs font-medium rounded-md hover:bg-yellow-600">Edit</button>
                            <button onclick="deleteRequest('${request.id}')" class="px-3 py-1 bg-red-500 text-white text-xs font-medium rounded-md hover:bg-red-600">Delete</button>
                        </div>
                    `;
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${request.stockName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.quantity}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${request.remarks}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">
                            ${request.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.docketNumber || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${request.timestamp}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${actionButtons}</td>
                `;
                engineerRequestsTable.appendChild(row);
            });
        }

        function sendStockRequest(event) {
            event.preventDefault();
            const name = document.getElementById('request-stock-name').value;
            const quantity = parseInt(document.getElementById('request-quantity').value);
            const remarks = document.getElementById('request-remarks').value;
            const newRequestId = `req-${Date.now()}`;

            stockRequests.push({
                id: newRequestId,
                stockName: name,
                quantity: quantity,
                requestedBy: currentUser.name,
                remarks: remarks,
                status: 'Pending',
                timestamp: new Date().toLocaleString(),
                urgent: false
            });
            document.getElementById('request-stock-form').reset();
            renderDashboards();
            showModal('Request Sent', `Your stock request for ${name} has been sent.`);
        }
        
        function sendUrgentRequest(event) {
            event.preventDefault();
            const name = document.getElementById('urgent-stock-name').value;
            const quantity = parseInt(document.getElementById('urgent-quantity').value);
            const remarks = document.getElementById('urgent-remarks').value;
            const newRequestId = `req-${Date.now()}`;

            stockRequests.push({
                id: newRequestId,
                stockName: name,
                quantity: quantity,
                requestedBy: currentUser.name,
                remarks: remarks,
                status: 'Pending',
                timestamp: new Date().toLocaleString(),
                urgent: true
            });
            document.getElementById('urgent-request-form').reset();
            renderDashboards();
            showModal('Urgent Request Sent', `Your urgent request for ${name} has been sent.`);
        }

        function editRequest(id) {
            const request = stockRequests.find(req => req.id === id);
            if (!request) return;

            const newName = prompt('Enter new stock name:', request.stockName);
            const newQuantity = prompt('Enter new quantity:', request.quantity);
            const newRemarks = prompt('Enter new remarks:', request.remarks);

            if (newName !== null && newQuantity !== null) {
                request.stockName = newName;
                request.quantity = parseInt(newQuantity);
                request.remarks = newRemarks;
                request.timestamp = new Date().toLocaleString();
                renderDashboards();
                showModal('Request Updated', `Your request for ${request.stockName} has been updated.`);
            }
        }

        function deleteRequest(id) {
            const requestIndex = stockRequests.findIndex(req => req.id === id);
            if (requestIndex > -1) {
                stockRequests.splice(requestIndex, 1);
                renderDashboards();
                showModal('Request Deleted', `Your request has been deleted.`);
            }
        }

        function markAsReceived(id) {
            const request = stockRequests.find(req => req.id === id);
            if (!request) return;

            request.status = 'Completed';
            request.timestamp = new Date().toLocaleString();

            const engineerId = currentUser.name;
            if (!engineerPersonalStock[engineerId]) {
                engineerPersonalStock[engineerId] = [];
            }

            const personalStockItem = engineerPersonalStock[engineerId].find(item => item.stockName === request.stockName);
            if (personalStockItem) {
                personalStockItem.quantity += request.quantity;
                personalStockItem.timestamp = new Date().toLocaleString();
            } else {
                engineerPersonalStock[engineerId].push({
                    stockName: request.stockName,
                    quantity: request.quantity,
                    timestamp: new Date().toLocaleString()
                });
            }
            renderDashboards();
            showModal('Stock Received', `You have marked ${request.quantity} of ${request.stockName} as received.`);
        }

        function renderEngineerPersonalStock() {
            engineerPersonalStockTable.innerHTML = '';
            const engineerId = currentUser.name;
            if (engineerPersonalStock[engineerId]) {
                engineerPersonalStock[engineerId].forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${item.stockName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.timestamp}</td>
                    `;
                    engineerPersonalStockTable.appendChild(row);
                });
            }
        }

        function addPersonalStock(event) {
            event.preventDefault();
            const name = document.getElementById('personal-stock-name').value;
            const quantity = parseInt(document.getElementById('personal-stock-quantity').value);

            const engineerId = currentUser.name;
            if (!engineerPersonalStock[engineerId]) {
                engineerPersonalStock[engineerId] = [];
            }

            const personalStockItem = engineerPersonalStock[engineerId].find(item => item.stockName === name);
            if (personalStockItem) {
                personalStockItem.quantity += quantity;
                personalStockItem.timestamp = new Date().toLocaleString();
            } else {
                engineerPersonalStock[engineerId].push({
                    stockName: name,
                    quantity: quantity,
                    timestamp: new Date().toLocaleString()
                });
            }
            document.getElementById('add-personal-stock-form').reset();
            renderDashboards();
            showModal('Personal Stock Added', `Personal stock for ${name} has been updated.`);
        }

        function renderEngineerUsageLog() {
            engineerUsageTable.innerHTML = '';
            const myUsageLogs = stockUsageLog.filter(log => log.engineer === currentUser.name);
            myUsageLogs.forEach(log => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${log.stockName}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.quantity}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.siteName}</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${log.reason}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.amcOrCmc}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${log.timestamp}</td>
                `;
                engineerUsageTable.appendChild(row);
            });
        }

        function useStock(event) {
            event.preventDefault();
            const stockName = document.getElementById('use-stock-name').value;
            const quantity = parseInt(document.getElementById('use-quantity').value);
            const siteName = document.getElementById('site-name').value;
            const reason = document.getElementById('use-reason').value;
            const amcOrCmc = document.getElementById('amc-cmc').value;

            const engineerId = currentUser.name;
            const personalStock = engineerPersonalStock[engineerId] || [];
            const item = personalStock.find(i => i.stockName === stockName);

            if (item && item.quantity >= quantity) {
                item.quantity -= quantity;
                item.timestamp = new Date().toLocaleString();

                stockUsageLog.push({
                    engineer: engineerId,
                    stockName,
                    quantity,
                    siteName,
                    reason,
                    amcOrCmc,
                    timestamp: new Date().toLocaleString()
                });
                document.getElementById('use-stock-form').reset();
                renderDashboards();
                showModal('Stock Used', `${quantity} of ${stockName} has been recorded as used.`);
            } else {
                showModal('Insufficient Stock', `You do not have enough ${stockName} in your personal stock.`);
            }
        }
        
        function updateStockDropdowns() {
            const requestDropdown = document.getElementById('request-stock-name');
            const useDropdown = document.getElementById('use-stock-name');

            if (requestDropdown) {
                requestDropdown.innerHTML = '';
                stockList.forEach(stock => {
                    const option = document.createElement('option');
                    option.value = stock.name;
                    option.textContent = stock.name;
                    requestDropdown.appendChild(option);
                });
            }

            if (useDropdown) {
                useDropdown.innerHTML = '';
                const engineerId = currentUser.name;
                if (engineerPersonalStock[engineerId]) {
                    engineerPersonalStock[engineerId].forEach(stock => {
                        const option = document.createElement('option');
                        option.value = stock.stockName;
                        option.textContent = stock.stockName;
                        useDropdown.appendChild(option);
                    });
                }
            }
        }

        function checkForAlerts() {
            // HOD Alerts
            const now = new Date();
            const lateRequests = stockRequests.filter(req => 
                req.status === 'Pending' && (now - new Date(req.timestamp)) >= alertThresholds.urgent
            );
            const lateSentRequests = stockRequests.filter(req => 
                req.status === 'Accepted' && (now - new Date(req.acceptedTimestamp)) >= sendAlertThresholds.red
            );

            if (lateRequests.length > 0 || lateSentRequests.length > 0) {
                hodUrgentAlerts.classList.remove('hidden');
                let message = 'You have urgent alerts: ';
                if (lateRequests.length > 0) message += `(${lateRequests.length}) pending requests > 5 days. `;
                if (lateSentRequests.length > 0) message += `(${lateSentRequests.length}) accepted requests not sent > 5 days. `;
                hodAlertMessage.textContent = message;
            } else {
                hodUrgentAlerts.classList.add('hidden');
            }
        }

        // Initial setup on page load
        window.onload = function() {
            // Populate initial dropdowns if user is an engineer
            if (currentUser && currentUser.role === 'Engineer') {
                updateStockDropdowns();
            }
        };

        // Re-render all dashboards whenever data changes
        function renderDashboards() {
            if (currentUser && currentUser.role === 'HOD') {
                renderHODRequests();
                renderStockList();
                renderEngineerManagement();
                renderHODEngineerStock();
                renderHODUsageLog();
                checkForAlerts();
            } else if (currentUser && currentUser.role === 'Engineer') {
                updateStockDropdowns();
                renderEngineerAvailableStock();
                renderEngineerRequests();
                renderEngineerPersonalStock();
                renderEngineerUsageLog();
            }
        }
    </script>

</body>
</html>